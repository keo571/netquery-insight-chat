# Netquery Insight Chat

React chat UI for the Netquery FastAPI backend. Ask infrastructure questions in natural language, get contextual SQL with markdown explanations, and surface schema hints when Netquery recommends a different direction.

## Highlights
- Conversational SQL with session tracking so follow-ups stay in context.
- Multi-database support in development mode (Sample and Neila databases).
- Same-origin deployment for production (single URL, zero config).
- Schema guidance blocks that list relevant tables and suggested prompts.
- Recharts visualisations that suppress themselves when the data is unsuitable.
- Progressive data tables with CSV downloads and server-side export support.

## Requirements
- Node.js 16+
- Netquery backend running (from `~/Code/netquery`)

---

## Development Mode

Development mode runs the frontend on a separate dev server (port 3000), enabling:
- Hot reload on code changes
- Database switching via UI
- React dev tools

**Terminal 1: Start Backend(s)**
```bash
cd ~/Code/netquery
./start-dual-backends.sh --dev    # Starts sample:8000 + neila:8001 with auto-reload
```

**Terminal 2: Start Frontend**
```bash
cd ~/Code/netquery-insight-chat
cp .env.example .env              # First time only
npm install                       # First time only
npm start                         # Starts on port 3000
```

**Access:** http://localhost:3000

| Feature | Status |
|---------|--------|
| Database selector | ✅ Visible |
| Hot reload | ✅ Enabled |
| Switch databases | ✅ sample ↔ neila |

---

## Production Mode

Production mode serves the frontend directly from the backend (same-origin), enabling:
- Single URL deployment
- Zero frontend configuration
- No CORS complexity

**Step 1: Build Frontend**
```bash
cd ~/Code/netquery-insight-chat
npm run build                     # Creates build/ folder
```

**Step 2: Start Backend**
```bash
cd ~/Code/netquery
SCHEMA_ID=neila python -m src.api.server --port 8001
```

**Access:** http://localhost:8001 (or your server IP/domain)

| Feature | Status |
|---------|--------|
| Database selector | ❌ Hidden |
| Hot reload | ❌ Rebuild required |
| Database | Fixed (determined by backend) |

The backend automatically serves the React build from `../netquery-insight-chat/build/`.

---

## Configuration

Copy `.env.example` to `.env` (development mode only):

```bash
# Backend URLs (only used in development mode)
# In production, frontend auto-detects via window.location.origin
REACT_APP_SAMPLE_URL=http://localhost:8000
REACT_APP_NEILA_URL=http://localhost:8001

# Force development mode (optional)
# REACT_APP_DEV_MODE=true

# UI Customization
REACT_APP_AGENT_NAME=Netquery
REACT_APP_WELCOME_TITLE=Welcome to Netquery!
REACT_APP_WELCOME_MESSAGE=Ask me about your infrastructure data.
REACT_APP_INPUT_PLACEHOLDER=Ask about your infrastructure data...
```

---

## Project Layout

```
├── src/
│   ├── components/        # Chat UI, tables, guidance blocks, visualisations
│   ├── hooks/             # useChat, useScrollToBottom
│   ├── services/api.js    # API calls with same-origin/cross-origin detection
│   ├── utils/             # Constants, debug helpers
│   └── __mocks__/         # Jest mocks
├── build/                 # Production build (generated by npm run build)
├── README.md              # This guide
├── .env.example           # Environment template
└── package.json
```

---

## Architecture

```
DEVELOPMENT (Cross-Origin)              PRODUCTION (Same-Origin)
========================               ==========================

┌─────────────────┐                    ┌─────────────────┐
│ React Dev Server│ :3000              │ User Browser    │
│ (npm start)     │                    └────────┬────────┘
└────────┬────────┘                             │
         │                                      │ http://server:8001
    ┌────┴────┐                                 │
    ▼         ▼                         ┌───────▼────────┐
┌───────┐ ┌───────┐                     │ Neila Backend  │ :8001
│Sample │ │Neila  │                     │ (serves React  │
│:8000  │ │:8001  │                     │  + API)        │
└───────┘ └───────┘                     └───────┬────────┘
                                                │
✅ DB switching enabled                 ┌───────▼────────┐
✅ Hot reload                           │ neila.db       │
                                        └────────────────┘

                                        ❌ DB switching disabled
                                        ✅ Single URL deployment
```

**How it works:**
- Frontend detects mode via `window.location.port`
- Port 3000 → Development (cross-origin, use configured URLs)
- Any other port → Production (same-origin, use `window.location.origin`)

---

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Backend not running | `cd ~/Code/netquery && ./start-dual-backends.sh --dev` |
| Port 3000 in use | `lsof -ti:3000 \| xargs kill -9` |
| Node issues | `rm -rf node_modules && npm install` |
| Schema not loading | Check backend health: `curl http://localhost:8000/health` |
| DB selector missing | Expected in production mode; use dev mode for switching |

---

## Related

- **Backend:** [~/Code/netquery](../netquery) - Unified server with SQL generation, session management, and static file serving
- **Architecture Decisions:** See [ARCHITECTURE_DECISIONS.md](ARCHITECTURE_DECISIONS.md) for detailed ADRs
